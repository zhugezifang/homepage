-- Cloudflareのやったほうがいい設定

1. 「SSL/TLS→概要」から「フル（厳密）」モードにする。

2. 「Caching→構成→ブラウザキャッシュTTL」から「既存のヘッダーを優先」にする。

3. 「Caching→Cache Rules」から同一ドメイン名のホスト名を含むすべてをエッジキャッシュの対象に追加するように構成する。
   ドメイン名がexample.comの場合は「ホスト名、次を含む、example.com」とする。
   この際に「再検証中に古いコンテンツを提供する」をオンにすることで微細ながらエッジキャッシュのヒット率の向上も図る。

4. 「Caching→階層型キャッシュ」から「スマート階層型キャッシュトポロジー」を有効にする。
   この設定はかなり重要でありエッジキャッシュのヒット率が2倍になることもある。

5. 「ルール→リダイレクトルール」で常時HTTPS化ルールを作成する。
   「URI、次で始まらない、/.well-known/」AND「SSL/HTTPS、等しい、オフ」にする。
   リダイレクト先は「動的、concat("https://", http.host, http.request.uri.path)、302」にする。

6. 「ルール→リダイレクトルール」でフラット化ルールを作成する。【任意】
   ドメイン名がexample.comの場合は「ホスト名、次と等しくない、example.com」にする。
   リダイレクト先は「静的、https://example.com/、302」にする。
   ワイルドカード「*」のプロキシ済みAレコードで192.0.2.1をターゲットにする。

-- 新しいマシンを設定

$ curl -fsSL https://get.docker.com/ -o install-docker.sh
$ sh install-docker.sh

$ echo "client_max_body_size 10g;" > nginx-upload-size.conf
$ docker run --detach \
  --name nginx-proxy \
  --publish 80:80 \
  --publish 443:443 \
  --volume certs:/etc/nginx/certs \
  --volume vhost:/etc/nginx/vhost.d \
  --volume html:/usr/share/nginx/html \
  --volume /var/run/docker.sock:/tmp/docker.sock:ro \
  --volume "$(pwd)"/nginx-upload-size.conf:/etc/nginx/conf.d/upload.conf:ro \
  nginxproxy/nginx-proxy
$ docker run --detach \
  --name nginx-proxy-acme \
  --volumes-from nginx-proxy \
  --volume /var/run/docker.sock:/var/run/docker.sock:ro \
  --volume acme:/etc/acme.sh \
  --env "DEFAULT_EMAIL=0xv75b42326631e@au.com" \
  nginxproxy/acme-companion

# https://github.com/yuukiwww/taiko-web

-- 太鼓ウェブのデータベース

エクスポート

$ docker exec -i taiko-mongo mongoexport --db taiko --collection users --out /dev/stdout | sort -n > users.json
$ docker exec -i taiko-mongo mongoexport --db taiko --collection songs --out /dev/stdout | sort -n > songs.json
$ docker exec -i taiko-mongo mongoexport --db taiko --collection scores --out /dev/stdout | sort -n > scores.json

コミット＆プッシュ

$ git add *.json
$ git commit --author="BOT <bot@example.com>" -m "$(git diff --name-only --cached | paste -s -d ' ') が更新されました"
$ git push origin main

インポート

$ docker cp users.json taiko-mongo:/a
$ docker exec -i taiko-mongo mongoimport --db taiko --collection users /a
$ docker cp songs.json taiko-mongo:/b
$ docker exec -i taiko-mongo mongoimport --db taiko --collection songs /b
$ docker cp scores.json taiko-mongo:/c
$ docker exec -i taiko-mongo mongoimport --db taiko --collection scores /c

